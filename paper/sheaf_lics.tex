\documentclass[conference]{IEEEtran}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{xspace}
\usepackage[colorlinks=true]{hyperref}

% *** MATH PACKAGES ***
%
\usepackage[cmex10]{amsmath}
\usepackage{amssymb,amsthm,amsfonts}


\newtheorem{thm}{Theorem}
\newtheorem{cor}[thm]{Corollary}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{defi}[thm]{Definition}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{ax}[thm]{Axiom}

\newcommand \defeq {\overset{de\hspace{-0.2ex}f}{=}}

\newcommand{\mynote}[2]{
    \fbox{\bfseries\sffamily\scriptsize#1}
    {\small$\blacktriangleright$\textsf{\emph{#2}}$\blacktriangleleft$}~}

\newcommand\kq[1]{\mynote{KQ}{#1}}
\newcommand\nt[1]{\mynote{NT}{#1}}

\newcommand{\ie}{i.e,\xspace}
\newcommand{\eg}{e.g,\xspace}

% *** Do not adjust lengths that control margins, column widths, etc. ***
% *** Do not use packages that alter fonts (such as pslatex).         ***
% There should be no need to do such things with IEEEtran.cls V1.6 and later.
% (Unless specifically asked to do so by the journal or conference you plan
% to submit to, of course. )


% correct bad hyphenation here
\hyphenation{op-tical net-works semi-conduc-tor}


\usepackage{enumerate}
\usepackage{wasysym}
\usepackage[all]{xy}
\def\dar[#1]#2{\ar@<-#2>[#1]\ar@<#2>[#1]} %double arrows in xy
\def\tar[#1]#2{\ar@<#2>[#1]\ar@<0pt>[#1]\ar@<-#2>[#1]} %triple arrows in xy
\DeclareMathOperator{\Type}{Type}
\DeclareMathOperator{\HProp}{HProp}
\DeclareMathOperator{\IsHProp}{IsHProp}
\DeclareMathOperator{\nat}{nat}
\DeclareMathOperator{\Unit}{Unit}
\DeclareMathOperator{\im}{Im}
\DeclareMathOperator{\id}{id}
\DeclareMathOperator{\Contr}{Contr}
\DeclareMathOperator{\IsContr}{IsContr}
\DeclareMathOperator{\postcompose}{\mathrm{postcompose}}

\def\mymathhyphen{{\hbox{-}}}

\newcommand{\IsType}[1]
{\mathop{\mathrm{Is\mymathhyphen}#1\mathrm{\mymathhyphen type}} }

\newcommand{\modal}{\ensuremath{\ocircle}}
\newcommand \True {\mathrm{true}}
\newcommand \False {\mathrm{false}}
\newcommand \closure[1] {\overline{#1}}
\newcommand \Char[1] {\chi_{#1}}%{\mathrm{char}(#1)}
\newcommand \E {\mathcal{E}}
\newcommand \Hom[1] {\mathrm{Hom}_{#1}}
\newcommand \Sh[1] {\mathrm{Sh}_{#1}}
\newcommand \squash[1] {\| #1 \| }
\newcommand \separated {\mathop{\square} }
\newcommand \fib[2] {\mathrm{fib}_{#1}(#2)}
\newcommand \colim[1] {\mathrm{colim}(Q)}
\newcommand \zero {\mathbf{0}}
\newcommand \one {\mathbf{1}}


 \IEEEpubid{} 

\begin{document}
%
% paper title
% Titles are generally capitalized except for words such as a, an, and, as,
% at, but, by, for, in, nor, of, on, or, the, to and up, which are usually
% not capitalized unless they are the first or last word of the title.
% Linebreaks \\ can be used within to get better formatting as desired.
% Do not put math or special symbols in the title.
\title{Lawvere-Tierney Sheafification\\ in Homotopy Type Theory}


% author names and affiliations
% use a multiple column layout for up to three different
% affiliations
\author{\IEEEauthorblockN{Kevin Quirin and Nicolas Tabareau}
\IEEEauthorblockA{Inria \\ \'Ecole des Mines de Nantes \\ Nantes, France}}

% conference papers do not typically use \thanks and this command
% is locked out in conference mode. If really needed, such as for
% the acknowledgment of grants, issue a \IEEEoverridecommandlockouts
% after \documentclass


% make the title area
\maketitle

% As a general rule, do not put math, special symbols or citations
% in the abstract
\begin{abstract}

  Sheafification is a popular tool in topos theory which
  allows to extend the internal logic of a topos with new
  principles. One of its most famous applications is the possibility
  to transform a topos into a boolean topos using the
  dense topology, which corresponds in essence to Gödel's double
  negation translation.
  % 
  The same construction has not been developed in Martin-Löf type
  theory because of a mismatch between topos theory and type theory. This
  mismatched has been fixed recently by considering homotopy type
  theory, an extension of Martin-Löf type theory with new
  principles inspired by category theory and homotopy theory, and
  which corresponds closely to higher topoi.
  % 
  In this paper, we give a computer-checked construction of
  Lawvere-Tierney sheafification in homotopy type theory, which allows
  in particular to give a meaning to the (propositional) law of
  excluded middle inside homotopy type theory, being
  compatible with the full type-theoretic axiom of choice.
  
\end{abstract}

% no keywords

\section{Introduction}
\label{sec:intro}

Sheafification~\cite{maclanemoerdijk} is a very powerful geometric
construction that has been initially stated in topology and has
quickly been lifted to mathematical logic.
%
In the field of topos theory, it provides a way to construct new topoi
from already existing ones, allowing logical principles---that can not
be proven to be true or false in the old topos---to be valid (or
invalid) in the new topos.
%
The most common use of sheafification is the construction a boolean
topos, thus validating the classical principle of the law of excluded
middle (EM), from an intuitionistic topos using the dense topology. 
%
An other famous application has been developed by
Cohen~\cite{cohen1966} to prove that the continuum hypothesis is
independent of the usual axioms of Zermelo-Fr\ae nkel set theory, even
in presence of the axiom of choice (AC). The initial work of Cohen
uses forcing but can be rephrased in terms of
sheafification~\cite{maclanemoerdijk}.

Even if similar questions have been considered around the Curry-Howard
isomorphism, there is no canonical way to extend a programming
language such as type theory with new logical or computational
principle while keeping consistency automatically.
%
For instance, much efforts have been done to provide a computational
content to the law of excluded middle in order to define a
constructive version of classical logic. This has lead to various
calculi, with most notably the $\lambda \mu$-calculus of
Parigot~\cite{parigot1993classical}, but this line of work has not
appeared to be fruitful to define a new version of type theory with
classical principles.
%
Other works have tried to extend continuation-passing-style (CPS)
transformation to type theory, but they have been faced with the
difficulty that the CPS transformation is incompatible with (full) dependent
sums~\cite{barthe2002cps}, which puts emphasis on the tedious link
between the axiom of choice and the law of excluded middle in type theory.

Nevertheless the axiom of choice has shown to be realizable by
computational meaning in a classical setting by techniques turning
around the notion of (modified) bar induction
\cite{berardi1998computational}, Krivine's
realizability~\cite{krivine2003dependent} and even more recently with
restriction on elimination of dependent sums and lazy
evaluation~\cite{herbelin2012constructive}.
%

Unfortunately, all those works---although they provide very nice and
sophisticated theoretical results---do not share the generality and
simplicity of sheafification in topos theory and are not amenable to a
direct integration into proof assistant based on type theory such as
Coq~\cite{coq:refman:8.4} or Agda~\cite{norell2007towards}.  
%
However, type theory is known to be quite closed to topos theory so
one could wonder why similar techniques have not been developed in the
field of type theory. 
%
The answer to this question has been given recently by the advent of
homotopy type theory~\cite{hottbook}, which is an extension of
Martin-Löf type theory with principles inspired by (higher) category
theory and homotopy theory, such as higher inductive
types~\cite{lumsdaine2011higher,lumsdaine2013higher} and
Voevodsky's univalence principle~\cite{kapulkin2012simplicial}. 
%

This new point of view on type theory has revealed the homotopy
structure of types where for instance mere propositions (or
$\Type_{-1}$) are just types with an
irrelevant equality and sets (or $\Type_{0}$) are types
with a propositional equality and so on for $\Type_{n}$.
%
The development of univalence has also shed some light on the
difficulty to make AC and EM coexist in type theory. Indeed, it
has been shown that a naive (non-propositional) version of EM is
inconsistent with univalence.

When restricted to mere propositions and sets, homotopy type
theory corresponds quite closely to topos theory but the mismatch
starts when considering higher homotopy types.
%
Fortunately, a higher version of topos theory has been developed
recently by mathematicians, synthesized in the monograph of Lurie on
higher topos theory~\cite{lurie}. 
%
Lurie has developed all the tools that have been defined in
topos theory, but in a higher setting. In particular, the theory of
sheaves has been lifted to higher topos theory.
%
As the notion of higher topoi appears to correspond very closely to
homotopy type theory, this provides a new hope that tackling the
problem of extending the power of homotopy type theory using
sheafification is actually possible.

Nevertheless, the adaptation of the sheafification in higher topos
theory to homotopy type theory is not straightforward because the
construction in higher topoi is restricted to the initial Grothendieck
setting which is still very topologically oriented, and not very
amenable to formalization in type theory. It seems more promising to
use a generalized notion of sheafification, called Lawvere-Tierney
sheafification~\cite{tierney1972sheaf,maclanemoerdijk}, but this construction has not
been considered yet in the setting of higher topos theory. This rises
two issues that this paper addresses: (i) how to lift the notion of
Lawvere-Tierney sheafification to higher topos theory and (ii) is it
possible to formalize this new definition in homotopy type theory.

\subsection{Lawvere-Tierney Sheafification in Topos Theory}
\label{sec:lawv-tiern-sheaf}

Lawvere-Tierney sheafification in a topos $\E$ is based on an abstract
point of view on the topology to be considered, being simply an
endomorphism on the classifying object $\Omega$ of $\E$  
%
$$
j : \Omega \rightarrow \Omega
$$
%
that is required to preserve $\True$ ($j \ \True = \True$), to be
idempotent ($j \circ j = j$) and compatible with products ($j \circ
\wedge = \wedge \circ (j, j)$).
%
A typical example is given by double negation.

Every Lawvere-Tierney topology $j$ induces a closure operator
$A \mapsto \closure{A}$ on subobjects. If we see a subobject $A$ of $E$
as a characteristic function $\Char{A}$, the closure $\closure{A}$
corresponds to the subobject of $E$ whose characteristic function is 
%
$$
\Char{\closure{A}} = j \circ \Char{A}.
$$
%
A subobject $A$ of $E$ is said to
be dense when $\closure{A} = E$.

The idea is then to define sheaves in $\E$ as objects of $\E$ for
which it is impossible to make a distinction between objects and their
dense subobjects. This idea is formalized by saying that for every
dense subobject $A$ of $E$, the following canonical map is an
isomorphism
%
\begin{equation}\label{equ:sheaf_def}
\Hom{\E}(E,F) \rightarrow \Hom{\E}(A,F).
\end{equation}
%
One can show that $\Sh{\E}$, the full sub-category of $\E$ given by
sheaves, is again a topos, with classifying object
%
$$
\Omega_j = \{ P \in \E \ | \ j P  = P \}.
$$
%
Thus, in case of the double negation, the resulting topos is boolean  
and admits classical reasoning.

But furthermore, one can defined a left adjoint to the inclusion, the
sheafification functor
%
$$
a_j : \E \rightarrow \Sh{\E}
$$
which exhibits $\Sh{\E}$ as a reflective
subcategory of $\E$ (which is a particular case of localization). This
means that logical principles valid in $\E$ are still valid in
$\Sh{\E}$.


\subsection{Overview of the Result}

The main contribution of this article is the development of a
computer-checked definition of Lawvere-Tierney sheafification in the
setting of homotopy type theory.
%
This provides a way to give a meaning to the propositional law of
excluded middle, and more generally, combined with the previous work on
forcing in type theory~\cite{jaber2012extending}, it allows to reuse
results derived for topos theory, such as independence results.

To extend Lawvere-Tierney sheafification to homotopy type theory, the
first thing to realize is that the construction can not be done in one
single step anymore. It must rather be performed by induction on the
level of homotopy types. More precisely, the first layer of
sheafification is defined for $\Type_{0}$, given a topology on
$\Type_{-1}$. This part corresponds to sheafification for topoi. Then,
assuming that the sheafification has been constructed up to level $n$,
one can defined the sheafification for $\Type_{n+1}$.
%
This inductive process in the definition of sheafification is similar
to construction in the Grothendieck setting, where the
sheafification is obtained by applying the plus-construction $n+1$
times to
$n$-types~\cite[Chapter~6]{lurie}.

This inductive step requires to formalize the notion of left-exact
reflective subuniverse, which corresponds to a stratified version of
left-exact modalities introduced in~\cite[Chapter~7]{hottbook}. A
Lawvere-Tierney topology can thus be seen as a left-exact modality on
$\Type_{-1}$ and sheafification as an inductive process that extends
it as a left-exact modality on $\Type_{n}$ for any $n$.

Compare to the definition of sheafification in topos theory, the main
change comes from the fact that in homotopy type theory, there is not
a single object classifier but rather an $n$-object classifier for
each $n\geq -2$ which classifies functions with $n$-truncated homotopy
fibers~\cite{sets_in_hott}. This means that when monomorphisms are used in topos
theoretic definition, the correct generalization may be $n$-truncated homotopy
fibers or embeddings (\ie $-1$-truncated homotopy
fibers) depending on the purpose of the definition.

For instance, the notion of separated objects (which is a technical
notion used in the construction of the sheafification functor), \ie
objects for which the morphism
(\ref{equ:sheaf_def}) is just an embedding, is generalized in two
different ways.  
%
The subobjects to be considered are given by $n$-truncated homotopy fibers,
while the morphism (\ref{equ:sheaf_def}) is still required to be an
embedding.

In other technical difficulty is the fact that sheafification in topos
theory uses the fact that epimorphisms are coequalizers of their
kernel pairs. This properties does not holds in higher topoi, but
using Giraud-Rezk-Lurie axioms of $\infty$-topoi, the same property
holds by replacing kernel pairs by \v{C}ech nerves in the statement.

Finally, one of the main difficulty in our formalization is that many
equalities which are trival (by proof irrelevance) in the topos theoretic
setting becomes relevant and requires a carreful use of univalence
with appropriate isomorphisms and a lot of reasoning on equalities
between paths.

\subsection{Plan of the Paper}

Section~\ref{sec:hott} defines the foundations of homotopy type theory
and presents a particular case of Giraud-Rezk-Lurie axioms. 
%
Section~\ref{sec:lexmod} introduces the notion of left-exact stratified
modalities, on which this paper is based.
%
Section~\ref{sec:sheaves} defines Lawvere-Tierney sheaves in homotopy
type theory.
%
Section~\ref{sec:sheafification} explains the construction of the
sheafification functor.
%
Section~\ref{sec:formalization} discusses the details of the
formalization in Coq, in particular issues concerning universe
polymorphism.
%
Finally, Section~\ref{sec:future-works} concludes on future works.


\section{Preliminaries on Homotopy Type Theory}
\label{sec:hott}

In this section, we review some basic definitions in homotopy type
theory that are central in our formalization but not specific to
sheafification. 
%
Section~\ref{ssec:hott} introduces the notion of homotopy types and
classifying objects as defined in~\cite{sets_in_hott}.
%
Section~\ref{sec:epi-mono-fact} presents the usual epi-mono
factorization system in the light of homotopy type theory.
%
Section~\ref{sec:colim-homot-type} introduces the notion of colimits
in homotopy type theory. 
%
And Section~\ref{sec:giraud-ax} defines a particular case of
Giraud-Rezk-Lurie axioms on higher topoi that we need in the
definition of sheafification.
%
The definition of Section~\ref{ssec:hott} are part of the Coq library
available at \url{https://github.com/HoTT/HoTT}, while other definitions
and theorems are specific to our formalization. 

As a prerequisite, we encourage the reader be familiar with type theory and
in particular the point of view developed
in~\cite{hottbook}. Nevertheless, we recall most of the central definitions 
that we use so that the paper is sufficiently self-contained.
%

 
 \subsection{Homotopy Types and Classifying Objects}
\label{ssec:hott}

One of the most direct application of homotopical notion to type
theory is the introduction of homotopy types. 
%
Using the analogy that points in a space correspond to elements of a
type and that paths between two points correspond to 
elements of the corresponding identity type (which defines equality in type theory),  
%
an $n$-type is simply a type
for which equality becomes trivial up to level $n$. 
%
Voevodsky has realized that this notion admits a compact inductive definition
internal to type theory, given by
% Our work is mainly based on the stratification by $\Type_n$~:
\begin{defi}
  $\IsType n$ is defined by induction on $n\geqslant -2$:
  \begin{itemize}
  \item $\IsType {(-2)} X$ if $X$ is a contractible type, \ie $X$
    is pointed by $c:X$, and every other point in $X$ is connected to $c$.
  \item $\IsType {(n+1)} X = \prod_{x,y:X} \IsType n (x=y).$
  \end{itemize}
  Then, $\Type_n = \sum_{X:\Type} \IsType n X$.
\end{defi}
% For a type $X$, to be in $\Type_n$ means that path spaces of $X$ are
% trivial after $n+1$ iteration.
%
We also define some syntactic sugar for contractible types and mere propositions.

\begin{itemize}
\item $\IsContr := \IsType {(-2)}$ and $\Contr := \Type_{-2}$
\item $\IsHProp := \IsType {(-1)}$ and $\HProp := \Type_{-1}$
\end{itemize}

Using $\Type_n$ instead of just $\Type$ is the first step to connect
type theory to higher topos theory. The next step is to exhibit a
hierarchy of subobject classifiers on $n$-truncated homotopy fibers.
%
The homotopy fiber $\fib{f}{b}$ of a function $f$ at element $b$ is
defined as 
$$
\fib{f}{b} \defeq \sum_{a:A} f(a) = b.
$$ 
%
A function $f$ is with $n$-truncated homotopy fibers (or simply
$n$-truncated function) when $\fib{f}{b}$
is an $\Type_n$ for any $b$.  
%
Following~\cite{sets_in_hott}, it is possible to show that, for any
homotopy level $n$ and any type $B$, $\Type_n$ classifies subobjects
of $B$ with $n$-truncated homotopy fibers in the sense that there is
an equivalence
%
$$\chi : \left(\sum_{A:\Type} \sum_{f:A \to B} \prod_{b\in B}
\IsType n\
\fib{f}{b}\right) \xrightarrow{\sim} 
 (B \to \Type_n)$$
%
 such that the following diagram is a pullback for any $f$ with
 $n$-truncated homotopy fibers:
$$
\xymatrix{
  A \ar[r]^{\hspace{-1em} t_f} \ar[d]_f & \Type_n^\bullet \ar[d]^{\pi_1}\\
  B \ar[r]_{\hspace{-1em} \chi_f} & \Type_n
}
$$
with $\Type_n^\bullet \defeq \sum_{A:\Type_n} A$ the universe of pointed
$n$-truncated types and 
$$t_f = \lambda a,~(\fib{f}{f(a)},(a,\mathrm{idpath})).$$

Finally, we need to use mere propositions as basic elements of a logic
when characterizing properties of types or functions. 
%
But as some constructors do not preserve the level of homotopy type
(\eg sums or $\Sigma$-types), we need to introduce $\squash{X}$, the
{\em (propositional) truncation} of $X$ (also called bracket type, or
squash type). This operation on types allows to truncate a type down
to a mere proposition. Then for instance, the existential
quantification on mere propositions ``there exists x:A such that
P(x)'' can be defined as $ \squash{\sum_{x:A} P(x)}.  $

Also proposition truncation could be seen as a primitive type former
in homotopy type theory, it can be defined using higher inductive
types. We adopt this point of view as it allows to maintain the slogan
that homotopy type theory is type theory plus univalence and higher
inductive types.
%

Given any type $X$, its propositional truncation 
$\squash{X} : \HProp$ is generated by 
\begin{itemize}
\item a function $|\cdot|_X : X \to \squash{X}$,
\item for any $x,y:\squash{X}$, a path $x=y$.
\end{itemize}
% 
The recursion principle $\squash{A}$ of asserts that any mere
proposition that follows from $A$ already follows from $\squash{A}$.
\begin{lem}
  For any $A:\Type$ and $B:\HProp$, if $f:A \to B$ then there is an
  induced $g:\squash{A}\to B$ such that $g(|a|)= f(a)$ for any $a:A$.
\end{lem}
%
We refer the reader to~\cite{hottbook} for more details on propositional truncation.

\subsection{The Orthogonal Factorization System}
\label{sec:epi-mono-fact}

We now recall the presence of a factorization system in homotopy type
theory, constituted by embeddings and surjections.

A map $f:A\to B$ is an \emph{embedding} when it is (-1)-truncated
(see definition in Section~\ref{ssec:hott}), and a \emph{surjection}
when it is (-1)-connected, that is when every fiber of $f$ is merely
inhabited (\ie $\|\fib f y\|$ holds for all $y$).

\begin{defi}
  Let $f:A\to B$ be a function. The {\em image} of $f$ is defined as 
  $$\im(f) \defeq \sum_{y:B} \|\fib f y\|.$$
\end{defi}

It is then fairly obvious that the canonical function $\hat f : A \to
\im(f)$ is (-1)-connected, thus the following proposition holds
(\cite{hottbook}, Lemma 7.6.4):
\begin{prop}
  A map $f:A\to B$ factors through $\im(f)$ as a (-1)-connected
  function followed by a (-1)-truncated function.
\end{prop}

Note that there are other factorization systems constituted by
$n$-truncated morphism and $n$-connected morphisms, for every
truncated level $n$, but they do not appear to be useful in the
definition of sheafification.

\subsection{Colimits in Homotopy Type Theory }
\label{sec:colim-homot-type}

In the definition of (a special case of) Giraud-Rezk-Lurie axiom given in
Section~\ref{sec:giraud-ax}, the colimit of the {\em \v{C}ech nerve}
plays a central role.
% 
Following the notion of (homotopy) limits of diagrams over graphs that
has been defined in homotopy type theory~\cite{lumsdaine}, we present
here a definition of colimits of diagrams overs graphs. 
%
The main difference between limits and colimits is that limits are
simply given by $\Sigma$-types, and thus exists already in traditional
type theory, whereas the situation is more complicated for colimits as
it requires the use of higher inductive types.


Following~\cite{lumsdaine}, we introduce the notion of graph and
diagram over a graph.
%
\begin{defi}
  A {\em graph} $G$ is the data of
  \begin{itemize}
  \item a type $G_0$ of vertices ;
  \item for any $i,j:G_0$, a type $G_1(i,j)$ of edges.
  \end{itemize}

  A {\em diagram} $D$ over a graph $G$ is the data of
  \begin{itemize}
  \item for any $i:G_0$, a type $D_0(i)$ ;
  \item for any $i,j:G_0$ and all $\phi : G_1(i,j)$, a map $D_1(\phi)
    : D_0(i) \to D_0(j)$
  \end{itemize}
\end{defi}

A colimit of a diagram $D$ over a graph $G$ is given by a type $P$
that defines a cone of $D$, plus the universal property that for any
type $X$, the canonical map that transforms a function $f : P
\rightarrow X$ to a cone of $D$ on $X$ is an isomorphism.
% 
\begin{defi}
Let $G$ be a graph, and $D$ be a diagram on $G$. 
Let $P:\Type$ together with
\begin{itemize}
\item a map $q_i : D_0(i) \to P$ for any
vertex $i:G_0$, \ie $$q : \prod_{i:G_0} D_0(i) \to P$$
\item for any vertices $i,j:G_0$ and all edges $\phi:G_1(i,j)$, a path
  $p_{i,j}^\phi : q_j \circ D_1(\phi) = q_i$, \ie
  $$p : \prod_{i,j:G_0} \prod_{\phi:G_1(i,j)} q_j \circ D_1(\phi) = q_i.$$
\end{itemize}

Then $P$ is the {\em colimit} of $D$ if for any other $X:\Type$, the
map
$$\lambda f:P \to X, \left( \lambda i,~f \circ q_i~;~ \lambda i\, j\,
  \phi,~ \postcompose_f (p(i, j, g)) \right)$$
where $\postcompose_f : \phi = \psi \to \phi \circ f = \psi \circ f$,
is an equivalence.
\end{defi}

% Essentially, being a colimit means making the diagram commutes, and
% being universal for this property.

Using higer inductive types, every diagram $D$ on a graph $G$ admits a
colimit in homotopy type thoery. This colimit $\colim D$ is given
%
\begin{itemize}
\item a function $q:\prod_{i:G_0} D_0(i) \to \colim D$
\item for any $i,j:G_0$ and $\phi:G_1(i,j)$, a path
  $q_j \circ D_1(\phi) = q_i$.
\end{itemize}
%
Although we have proven in our formalization that $\colim D$ is
actually a colimit over $D$, we do not detail the proof here as the
existence of colimits is not used in the definition of the
sheafification process. We only make use of the following special case
of Giraud-Rezk-Lurie axioms.

\subsection{On Giraud-Rezk-Lurie axioms}
\label{sec:giraud-ax}

The Giraud-Rezk-Lurie axioms are the $\infty$-version of Giraud's
axioms that characterize a topos. Namely, there are 4 axioms on a
$(\infty,1)$-category that have been shown to be equivalent to be
equivalent to $(\infty,1)$-topos~\cite[Chapter 6]{lurie}. This is not
the purpose of this paper to discuss those axioms, we only state here
a particular case of the last axiom which says that every groupoid
object is effective. 
%
This particular case connects a surjection (or a $(-1)$-connected
function) to the colimit of its \v{C}ech nerve.
%
This is the $\infty$-generalization of the fact that, in a topos,
every epimorphism is the colimit of its kernel pair, which plays a
central part in the definition of sheafification.

\begin{defi}
  Let $f:X \to Y$ be a map, and $p:\nat$. The $p$-pullback of $f$
  (also called the $p$-fold fiber product of $X$ over $Y$),
  noted $X\times_Y \cdots\times_Y X$, is
  the limit of the diagram
  $$\xymatrix{
    X \ar[rd]^f & \cdots & X \ar[ld]_f \\
      &    Y   &
  }$$
  with $p$ copies of $X$. The $0$-pullback of $f$ is $\Unit$.
\end{defi}

As explained in Section~\ref{sec:colim-homot-type}, every limit exists
in (homotopy) type theory and can be described by a $\Sigma$-type. 
%
The particular case of a $p$-pullback is given by
%
$$
X\times_Y \cdots\times_Y X = \sum_{x:X^n} (f x_1 = f x_2) \land
\cdots \land (f x_{n-1} = f x_n).
$$
%
The \v{C}ech nerve of a map $f$ can then be described as the
simplicial object that, at degree $p$, is given by the
$(p+1)$-pullback of $f$. The \v{C}ech nerve can thus also be described
as a diagram over $\Delta^{op}$ (where $\Delta$ is the simplicial
category, seen as a graph). For simplicity, we only give an intuitive
definition here, the complete definition can be found in our
formalization.
%
\begin{defi}
  Let $f$ be a map from $X$ to $Y$. The {\em \v{C}ech nerve} $C(f)$ of $f$
  is given by the diagram
  $$\xymatrix{
    C(f) := \cdots~ X \times_Y X \times_Y X \tar[r]{4pt} & X \times_Y X \dar[r]{2pt} & X
  }$$
where the arrows are the canonical projections.
\end{defi}

\begin{ax}[Giraud-Rezk-Lurie]
  For any surjection $f : X \to Y$, the colimit of its \v{C}ech nerve
  $C(f)$ is $Y$.
\end{ax}

With the point of view that homotopy type theory is a type-theoristic
version of higher topos theory, Theorem 6.1.0.6 of~\cite{lurie}
suggests that this axiom can be proved in homotopy type theory. 
%
But proving this axiom seems to be a quite complex task on its own,
and we have decided to admit it in this paper.



\section{Left exact Modalities}
\label{sec:lexmod}

This section is devoted to the definition and analyze of left exact
modalities as they have been introduced in \cite{hottbook} and
\cite{shulman-higher-modalities}. Our definition differs slightly from
those work in that we restrict the definition of the modality to be
$n$-truncated types for a given truncation index $n$, instead of on
all types.
%
This implies that we cannot reuse directly all results developed
in~\cite{hottbook} as some care must be taken to check that truncation
levels are preserved.

Note that similar notion of modal operator have been already studied
extensively in non-dependent type
theory~(see \eg \cite{benton1998computational}). In those works, they connect
modalities to computational monad in programming
languages~\cite{moggi-monad}. However, in our setting, modalities
correspond to idempotent monads, a property that is rarely true 
in functional programming, except for the identity monad of course.

The notion of left exact modalities plays a central role in this paper
because Lawvere-Tierney topologies corresponds exactly to left exact
modalities at $-1$ and sheafification is described as an inductive
process that produces a left exact modality at level $n+1$ from a
level exact modality at level $n$. 

Section~\ref{sec:definition} presents the definition and basic
properties of left exact modalities. 
%
Section~\ref{sec:new-type-theory} discusses how a left exact modality
induces a new homotopy theory, and in which case this theory is
consistent.
%
Finally, Section~\ref{sec:examples-left-exact} introduces some
example, and in particular the modality for the dense topology.

\subsection{Definition and Basic Properties}
\label{sec:definition}

% We use the following definition of truncated left exact modalities:
\begin{defi}
  \label{sec:defin-basic-prop-1}
  Let $n\geq -1$ be a truncation index. A left exact modality at level
  $n$ is the data of
  \begin{enumerate}[(i)]
  \item A predicate $P:\Type_n \to \HProp$
  \item For every $n$-truncated type $A$, a $n$-truncated type
    $\modal A$ such that $P(\modal A)$
  \item For every $n$-truncated type $A$, a map $\eta_A:A \to
    \modal A$
  \end{enumerate}
  such that
  \begin{enumerate}[(i)]
    \setcounter{enumi}{3}
  \item For every $n$-truncated types $A$ and $B$, if $P(B)$ then
    $$\left\{
      \begin{array}{rcl}
        (\modal A \to B) & \to & (A \to B) \\
        f & \mapsto & f \circ \eta_A
      \end{array} \right.$$
    is an equivalence.
  \item for any $A:\Type_n$ and $B:A \to \Type_n$ such that $P(A)$
    and $\prod_{x:A} P(B x)$, then $P\left( \sum_{x:A} B(x)\right)$
  \item for any $A:\Type_n$ and $x,y:A$, if $\modal A$ is
    contractible, then $\modal (x=y)$ is contractible.
  \end{enumerate}
  Conditions (i) to (iv) define a {\em reflective subuniverse}, (i) to
  (v) a {\em modality}.
\end{defi}

The type of all modal $n$-types, \ie types for which $P$ holds, is
defined as %$\Type^\modal_p$, so 
$$
\Type^\modal_n \ \defeq \sum_{T : \Type_n} P (T).
$$
%
Since basic type formers (dependent products, products, sigma types)
preserves truncation levels, we can leverage all theorems on modalites
presented in~\cite[Chapter 7.7]{hottbook}.
%
We now summarize the main properties that are used in our
formalization. We do not recall the proofs as they are not specific to
our presentation (also the setting using truncated types provides
minor changes), but they can be found in our Coq formalization. 
 
\begin{prop}

The following property holds for any left-exact modality $\modal$ at
level $n$.
 
\begin{itemize}

\item $\one$ seen as an $n$-type is modal, ie $\modal \one =\one$.
\item 
  For any  $A:\Type$ and $B:A \to \Type_n^\modal$,  $P\left(\prod_{a:A} (B\,
  a)\right)$. \\
(from \cite[Lemma 7.7.2]{hottbook})
\item For any $A,B:\Type_n$,
  $\modal (A\times B) = (\modal A) \times (\modal B)$. \\
(from \cite[Corollary 7.7.2]{hottbook})
\item For any $A:\Type_n^\modal$ and $x,y:X$, $P(x=y)$.
\item 
  {\it (iv)} can be extended to dependent product, that is for any $A:\Type_n$, $B:\modal A \to
  \Type_n^\modal$ and
  $g:\prod_{a:A} B(\eta_A(a))$, there exists a map $f:\prod_{z:\modal
    A} (B\, z)$ such that for all $a:A$, $f(\eta_A(a)) = g(a)$. \\
 (from \cite[Theorem
 7.7.4]{hottbook})
\end{itemize}
\end{prop}

As the definition of sheafification is based on subobject classifiers
and thus on homotopy fibers, we need to take a closer look at the way left
exact modalities preserve homotopy fibers.
%
\begin{prop}
\label{sec:defin-basic-prop}
For any $n$-truncated types $X$ and $Y$,
and any map $f:X \to Y$, the modalisation of fiber of $f$ above any element $y:Y$
is the fiber of $\modal f$ above $\eta_Y y$:
$$\modal \left(\sum_{x:X}  (f x = y)\right) = \sum_{x:\modal X}
(\modal f x = \eta_Y y),$$
where $\modal f:\modal X \to \modal Y$ is defined via the equivalence {\it (iv)} and $\eta_Y$.

Moreover the following diagram commute
$$\xymatrix{
  \sum_{x:X} (f x = y) \ar[r]^\eta \ar[d]_\gamma & \modal \left(\sum_{x:X}  (f x = y)\right) \ar@{=}[dl]\\
  \sum_{x:\modal X} (\modal f x = \eta_Y y) & }$$
where $\pi_1 \circ \gamma = \eta_X \circ \pi_1$, and
$\pi_2 \circ \gamma$ is given by the modalisation of
paths.\footnote{This proposition comes from on old version of the
  formalization of left exact modalities in the HoTT library, but is
  not present anymore in the library.}
\end{prop}
\begin{proof}
% \nt{ça a du sens de mettre une preuve, non ? c'est non trivial et
%   nouveau par rapport aux travaux sur les modalités. Ou alors c'est
%   la preuve de Shulman qui tu n'as pas faite. En tout cas, il faut
%   clarifier.}

The proof is based on the following central result.
\begin{lem}
  Let $X:\Type_p$, $Y:\Type_p\modal$ and $f:X\to Y$. If for all $y:Y$,
  $\modal (\fib f y)$ is contractible, then $\modal X = Y$.
\end{lem}
%
It is straighforward to define a map
$$\phi:\sum_{x:X}  (f x = y)\to
\sum_{x:\modal X} (\modal f x = \eta_Y y),$$
using $\eta$ functions.
We just need to check that every $\modal(\fib \phi {x;p})$ is
contractible.
Technical transformations allow to prove
$$\fib\phi{x;p} = \fib s {y;p^{-1}}$$
for some $a:\modal X$, $b:\modal Y$ and 
$$s:\fib{\eta_X}a \to \fib{\eta_Y}b.$$
%
From definition of left exactness, one can deduce the following:
\begin{lem}
  Let $A,B:\Type_p$. Let $f:A\to B$. If $\modal A$ and $\modal B$ are
  contractible, then so is $\fib f b$ for any $b:B$.
\end{lem}
Thus, we just need to prove that $\modal(\fib {\eta_X} a)$ and
$\modal(\fib {\eta_Y} b)$ are contractible.
But we have the lemma:
\begin{lem}
  Let $A:\Type_p$. Then for any $y:\modal A$, $\modal(\fib {\eta_A}
  y)$ is contractible.
\end{lem}

Finally, $\modal(\fib s{y;p^{-1}})$ is contractible, so $\modal(\fib \phi {x;p})$ also, and the result is proved.
%\kq{Finish that}

%\nt{Indeed, I can't follow the proof for the moment}
\end{proof}

In the same way, left exact modalities preserve homotopy types.
\begin{prop}
  Let $k \leq n$.
  If $P:\Type_k$, then $\modal \widehat P : \Type_k$, where $\widehat P$
  is $P$ seen as a $n$-type.
\end{prop}
\begin{proof}
  An $n$-truncated type $P$ can equivalently be described as a type for
  which the unique map to $\one$ is with $n$-truncated fibers. Thus, the
  property is a direct corollary of
  Proposition~\ref{sec:defin-basic-prop} and the fact that $\modal \one =
  \one$.
\end{proof}

\subsection{The new type theory arising from a left exact modality}
\label{sec:new-type-theory}

As noticed in \cite{hottbook}, left exact modalities corresponds 
to sub-$(\infty,1)$-topoi. Indeed, modal types defines a new type
theory as modality preserves all type former, such as dependent
products, dependent sums or inductive types (\nt{double check that}). 

Furthermore, when $A$ and $B$ are modal and $f : A \to B$, the mere
proposition of $f$ being an equivalence is also modal. This means that
univalence also holds in $\Type^\modal_p$, so it induces a good notion
of homotopy type theory.

Every left exact modality induces a new homotopy type theory, but with more
properties, that can make it inconsistent. We now provide a simple
characterization of left exact modalities that give rise to a
consistent theory.

\begin{prop}\label{prop:consistent}
  A left exact modality $\modal$ induces a consistent type theory if
  and only if $\modal \zero$ can not be inhabited in the initial type
  theory. In that case, the modality is said to be consistent.
\end{prop}
\begin{proof}
  By condition (iv) of Definition~\ref{sec:defin-basic-prop-1},
  $\modal \zero$ is an initial object of $\Type^\modal_p$, and thus
  corresponds to false for modal mere proposition.
  % 
  As $\modal \one = \one$, $\Type^\modal_p$ is consistent when
  $\modal \zero \neq \one$, that is when there is no proof of
  $\modal \zero$.
\end{proof}

\subsection{Examples of Left Exact Modalities}
\label{sec:examples-left-exact}

A first example of left exact modality for every level $p$ is the {\em
  open modality of $P$} for a $P:\HProp$ defined as
$\modal_P T = P \to T$.
%
When one works in
the subuniverse defined by this modality, defining an inhabitant of a
type $T$ amounts to give an inhabitant of $P \to T$. 
%
Thus, being in this subuniverse corresponds to adding the axiom $P$ to the
theory. Of course, adding an axiom this way does not add any computational
content to $P$, and the consistency of the modallity corresponds to
the fact that $P \to \zero$ (or $\lnot P$) is not inhabited.

Another example of left exact modality for every level $p$ is the
double negation modality,
$\modal_{\lnot\lnot} T = (T \to \zero) \to \zero$.
%
This modality is consistent as $\modal_{\lnot\lnot} \zero = \zero$ can
not be inhabited.
%
Using the double negation modality enables to use classical reasonings
in the corresponding reflective subuniverse, but every type in the new
universe is collapsed to an $\HProp$, ending up with propositional
classical logic.

In this paper, we use the double negation modality at level $-1$ only,
and then extend it to higher homotopy types using sheafification. This
way, we can add classical reasoning in the type theory without
collapsing the theory to mere propositions.




\section{Sheaves}
\label{sec:sheaves}

As explained in the introduction, a Lawvere-Tierney topology for an
topos $\E$, as defined in Section~\ref{sec:lawv-tiern-sheaf},
corresponds to a left exact modality at level $-1$.
%
And sheafification corresponds to lifting this modality to a left
exact modality at level $0$.
%
In homotopy type theory, it is possible to use similar ideas to lift
any left exact modality at level $n$ to a left exact modality at level
$n+1$ using sheafification.

In this section, we suppose given a truncation index $n\geqslant -1$,
and a left exact modality $\modal$ on $\Type_n$ and we introduce the
definition of sheaves for $(n+1)$-types and basic properties of
sheaves that will be useful in the next section. 

% We will define sheaves by induction on the level of homotopy type:
% the base case will be any left exact modality on $\HProp$, and we
% give in this section some definitions useful for the inductive case.

% \subsection{Definitions and first properties}
% \label{sec:def}

To define sheaves, we first have to leverage the notion of dense
subobjects for the modality $\modal$. The closure operator is defined
using the $n$-subobject classifier $\Type_n$ introduced in
Section~\ref{ssec:hott}.

\begin{defi}
  Let $E$ be a type. The {\em closure} of a subobject of $E$ with
  n-truncated homotopy fibers (or $n$-subobject of $E$, for short),
  classified by $\chi : E \to \Type_n$, is the subobject of $E$
  classified by $\modal \circ \chi$.

  An $n$-subobject of $E$ classified by $\chi$ is said to be {\em
    closed in $E$} if it is equal to its closure, \ie
  $\chi = \modal \circ \chi$.
\end{defi}

The definition of a dense $n$-subobject requires more work as the
characteristic function $\chi_E$ of $E$ seen as an $n$-subobject of
itself is not the constant function equal to $\one$ as it is the case
for topoi, but rather the map 
%
$$\chi_E  = \lambda e . \ \sum_{e':E} e=e'.$$
%
This means that we need to take more care of the homotopy structure of
this charactestic function, and in particular, the definition of a
dense $n$-subobject comes with an additional coherence condition
(which is trivial when $n=-1$).

\begin{defi}
  Let $E$ be a type, and $\chi:E \to \Type_n$. The subobject $\iota :
  A \to E$ of $E$
  classified by $\chi$ is {\em dense} in $E$ when its $\modal$-closure
  is equvialent to $\chi_E$, \ie
  %
  $$\forall e:E,~ \left(\sum_{e':E} e=e'\right) \simeq (\modal
  (\chi~e)).$$
  % 
  and moreover, for any $x:A$, the following diagram 
  commutes, 
  $$\xymatrix{
    \sum_{e':A} x = e' \ar@{=}[r] \ar[d]_{\iota'} & (\chi~x) \ar[d]^{\eta_{(\chi~x)}}\\
    \sum_{e':E} x = e' \ar@{=}[r] & \modal (\chi~x)
  }$$
  where $\iota': x \mapsto (\iota (\pi_1 x) ; \pi_2 x)$.
\end{defi}

It follows from homotopy fibers preservation that any $n$-subobject of
a type seen as a $n$-subobject of its closure is closed.

As recall in Section~\ref{sec:lawv-tiern-sheaf}, in topos theory,
sheaves are elements that can not distinguish between objects and
their dense sub-objects. 

\begin{defi}
  For any type $A$ and $E$, $\iota : A \to E$ and $F:\Type_{n+1}$, we define
    $$
    \Phi_E^\iota : (E \to F) \to (A \to F) 
    $$
    %
    as the map sending an
    arrow $f:E\to F$ to its restriction the restriction of $f \circ m$.
  % \item if $A \to E$ with $n$-truncated homotopy fibers, $\Phi_E^\chi$ is the
  %   map sending $f:~E \to f$ to $\restriction f A$.
  % \end{itemize}
\end{defi}

Here, we need to distinguish between
dense $(-1)$-subobjects, that will be used in the definition of
sheaves, and dense $n$-subobjects, that will be used in the definition
of separated types. 

\begin{defi}[Separated Type]
  A type $F$ in $\Type_{n+1}$ is {\em separated} if for any type $E$, and
  all dense $n$-subobject of $\iota : A \to E$,
  $\Phi_E^\iota$ is an embedding. In other words, the dotted arrow,
  if exists, is unique.

  $$\xymatrix{
    A \ar[r]^f \ar[d]_{\iota} & F \\
    E \ar@{-->}[ru]_{!}&
  }$$
\end{defi}

\begin{defi}[Sheaves]
  A type $F$ of $\Type_{n+1}$ is a {\em $(n+1)$-sheaf} if it is
  separated, and for any type $E$ and all dense $(-1)$-subobject of
  $\iota : A \to E$, $\Phi_E^\iota$ is an
  equivalence. In other words, the dotted arrow exists and is unique.

  $$\xymatrix{
    A \ar[r]^f \ar[d]_{\iota} & F \\
    E \ar@{-->}[ru]_{\exists !}&
  }$$
\end{defi}

Note that these definitions are almost the same as the ones
in~\cite{maclanemoerdijk}. The main difference is that {separated}
is defined for $n$-subobjects, while {sheaf} only for
$(-1)$-subobjects.
%
For higher topos theory, in the Grotehndieck setting, sheaves seems
to correspond to the second part of our definition only (assuming that
Lawvere-Tierney topologies can still be shown to subsume Grothendieck
toplogies for $(\infty,1)$-topoi, which is beyond the scope of this paper).
%

A fundamental property in the construction of the sheafification is
the fact that the type of modal types at level $n$ defines a sheaf. 
%
This property initially holds in the topos theoretic construction, but
it requires much work here, as we have to deal with equalities. In
particular, this property uses the specific definition
of separated types and sheaves, which shows that we had actually no
choice in their statement. 


\begin{prop}\label{prop:sheaf-is-sheaf}
  $\Type_n^\modal$ is a sheaf.
\end{prop}
\begin{proof}
  First, we prove that $\Type_n^\modal$ is separated. Let $E:\Type$
  and $\chi:E \to \Type_n$, dense in $E$. Let $\phi_1,\phi_2:E \to
  \Type_n^\modal$, such that $\phi_1 \circ \pi_1 = \phi_2 \circ
  \pi_1$ and let $x:E$. We show $\phi_1 x = \phi_2 x$ using
  univalence.

  As $\chi$ is dense, we have a term $m_x : \modal(\chi\, x)$.
  But as $\phi_2 x$ is modal, we can obtain a term $h_x : \chi\,
  x$. 
  As $\phi_1$ and $\phi_2$ are equal on $\sum_{e:E}\chi\, e$, we
  have an arrow $\phi_1 x \to \phi_2 x$.
  The same method leads to an arrow $\phi_2 x \to \phi_1 x$, and we
  prove they are each other inverse.

  Now, we prove that $\Type_n^\modal$ is a sheaf. Let $E:\Type$ and
  $\chi:E \to \HProp$, dense in $E$. Let $f:\sum_{e:E} \chi\, e \to
  \Type_n^\modal$. We want to extend $f$ to $E \to \Type_n^\modal$.

  We define $g$ as 
  $$g(e) = \modal \left( \fib \phi e \right), $$
  where
  $$\phi : \left(\sum_{b:\left(\sum_{e:E} (\chi\, e)\right)} (f\,
    b)\right) \to E$$
  defined by $\phi(x) = (x_1)_1$.
  Using the following properties on fibers, we can prove that it
  defines an equivalence.
  \begin{lem}
    Let $A,B,C:\Type_n$, $f:A\to B$ and $g:B\to C$.
    Then
    \begin{itemize}
    \item If $g$ is an embedding, then 
      $$\forall b:B,~\fib f b = \fib {g\circ f} {g\, b}.$$
    \item If all fibers of $f$ and $g$ are $n$-truncated, then
      $$\forall c:C,~\modal(\fib {g \circ f} c) =
      \modal \left(  
        \sum_{w:\fib g c} \modal (\fib f {w_1})
      \right).$$
    \end{itemize}
  \end{lem}

\end{proof}

An other fundamental property on sheaves is that the type of (dependent)
functions is a sheaf as soon as its codomain is a sheaf.

\begin{prop}\label{prop:sheaf-forall}
  If $A:\Type_{n+1}$ and $B:A \to \Type_{n+1}$ such that for any
  $a:A$, $(B~a)$ is a sheaf, then $\prod_{a:A}B~a$ is a sheaf.
\end{prop}
\begin{proof}
  \begin{itemize}
  \item {\em Separation:} Let $E:\Type$, $\chi:E \to \Type_n$ dense
    and $\phi_1,\phi_2:E\to \prod_{a:A} (B\, a)$ equal on
    $\sum_{e:E}(\chi\, e)$ \ie $\phi_1\circ \pi_1 = \phi_2\circ
    \pi_1$.
    Then for any $a:A$, $(\lambda x:E,~\phi_1\, x\,
    a)$
    and $(\lambda x:E,~\phi_2\, x\, a)$
    coincide on $\sum_{e:E}(\chi\, e)$, and as $B\, a$ is separated,
    they coincide also on all $E$.
  \item {\em Sheaf:} Let $E:\Type$, $\chi:E\to \HProp$ dense and
    $f:\sum_{e:E} (\chi\, e)\to \prod_{a:A} (B\,a)$. Let $a:A$ ; the
    map $(\lambda x,~f\,x \,a)$ is valued in the sheaf $B\, a$, so it
    can be extended to all $E$, allowing $f$ to be extended to all $E$.
  \end{itemize}
%  \nt{add a short proof here}
\end{proof}

\section{Construction of sheafification}
\label{sec:sheafification}

% We mimic the construction in~\cite{maclanemoerdijk}. 

From any left exact modality $\modal_{-1}$ on $\HProp$, we define by
induction on the truncation index $n$, a
left exact modality $\modal_n$ at level $n$ that extends $\modal_{-1}$ in the
sense that the following property holds.
%
% We have to be careful: if we want to propagate the properties of the
% first modality $\modal_{-1}$, all the higher modalities $\modal_n$ must be compatible
% with $\modal_{-1}$, \ie we want the property
\begin{prop}\label{prop:hprop}
  For any mere proposition $P$ (with $\widehat P$ is $P$ seen as a
  $\Type_n$),  $\modal_n \widehat P = \modal_{-1} P$ and the
  following coherence diagram commutes
  $$\xymatrix{
    P \ar@{=}[r] \ar[d]_{\eta_{-1}} & \widehat P \ar[d]^{\eta_n} \\
    \modal_{-1} P \ar@{=}[r] & \modal_n \widehat P 
  }$$
\end{prop}


Note that once the first modality $\modal_{-1}$ is defined, its
extension to all $\Type_n$ is automatic. This means that the new
logical principles that can be added by the sheaf construction must be
added in the first modality already. Sheafification is just a way
to propagate those new principles to types than are not mere
propositions.


%   extend the new principles it gives to
% every $\Type_n,\,n\geqslant 0$.  Actually, if $n_0$ is a fixed
% truncation index, and $\modal$ a left exact modality on $\Type_{n_0}$,
% then we can in the same way extend the properties of the modality to
% any $\Type_n$, for $n > n_0$.



The sheafification in topos theory described in
Section~\ref{sec:lawv-tiern-sheaf} works in the same way. 
%
From a left exact modality on the internal logic (a Lawvere-Tierney
topology), a new left exact modality is defined on the whole topos.
%
This construction may be seen as the first induction step between
$\HProp$ and $\Type_0$. 

\nt{je ne comprends pas ce passage, c'est quoi sheafness ? }

\kq{c'est une vision plutôt grothendieck en fait. La separation ``enlève''
  ce qui empêche à $T$ d'être un faisceau, et la sheafification
  rajoute ce qui manque pour être un faisceau. Mais c'était plutôt mal
  dit, effectivement}

For a given induction step, the sheafification is defined in two
steps:
\begin{enumerate}[(i)]
\item {\em separation:} In this step, we construct a {\em free}
  separated object.
\item {\em completion:} In this step, we add what lacks now to the
  separated type to be a sheaf.
\end{enumerate}

% \subsection{For mere propositions}
% \label{ssec:h-propositions}

% For the case $n=-1$, one can take any left exact modality on
% $\HProp$. Here we took the $\lnot\lnot$ modality:
% $$\forall P:\HProp,~\modal_j P = \lnot\lnot P.$$
% One can easily show that it defines a left exact modality.

% The $\lnot\lnot$-modality allows to work with a propositional law of
% excluded middle. 

In the rest of the section, we suppose given a truncation index
$n\geqslant -1$, and a left exact modality $\modal_n$ on $\Type_n$,
compatible with a left exact modality $\modal_{-1}$ on $\HProp$ in the
sense of proposition~\ref{prop:hprop}.

\subsection{From Type to Separated Type}
\label{ssec:from-type-separated}

Let $T : \Type_{n+1}$. We define $\separated T$ as the image (see
Section~\ref{sec:epi-mono-fact}) of
$\modal_n^T \circ \{\cdot\}_T$, as in
$$\xymatrix{
  T \ar[r]^{\{\cdot\}_T} \ar[d]_{\mu_T} & \Type_n^T \ar[d]^{\modal_n^T} \\
  \separated T \ar[r]& \left( \Type_n^\modal \right)^T
}, $$
where $\{\cdot\}_T$ is the singleton map $\lambda (t:T),~\lambda
(t':T),~t=t'$.
%
$\separated T$ can be given explicitly by
%
$$
\begin{array}{rcl}
\separated T &\defeq & \im (\lambda~t:T,~\lambda~ t',~ \modal_n (t = t')) \\
          & \defeq & \sum_{u:T \to \Type_n^\modal} \left\| \sum_{a:T} 
            (\lambda t,~\modal_n (a=t)) = u\right\|.
\end{array}
$$
%
This corresponds to the free separated object used in the topos
theoretic construction, but using $\Type_n^\modal$ instead of the
$j$-subobject classifier $\Omega_j$.
%
\begin{prop}
  For any $T:\Type_{n+1}$, $\separated T$ is separated.  
\end{prop}

\begin{proof}
We use the following lemma:
\begin{lem}
  A $(n+1)$-truncated type $T$ with an embedding $f : T \to U$
  into a separated $(n+1)$-truncated type $U$ is itself separated.
\end{lem}
As $\separated T$ embeds in $\left( \Type_n^\modal \right)^T$, we only
have to show that the latter is separated. But it is the case because
$\Type_n^\modal$ is a sheaf (by Proposition~\ref{prop:sheaf-is-sheaf})
and a function type is a sheaf as soon
as its codomain is a sheaf (by Proposition~\ref{prop:sheaf-forall}).
\end{proof}

To show that $\separated$ is a modality, we need to show that $\separated T$
is universal among separated type below $T$. This comes from the
following central lemma which connects $\separated T$ to the colimit of
the \v{C}ech nerve of $\mu_T$.

\begin{lem}\label{lem:sepiscolim}
  Let $T:\Type_{n+1}$. Then $\separated T$ is the colimit of the closed
  diagonal diagram
  $$\xymatrix @C=4em  { 
    \cdots \overline{\Delta_3} \tar[r]{4pt} & \overline{\Delta_2} \dar[r]{2pt} &
    \overline{\Delta_1}
  }$$
where $\Delta_k$ is the $k$-pullback of $\id : T \to T$.
\end{lem}

Again, this lemma is an adaptation of the sheafification process in
topos theory, where the kernel pair of $\mu_T$
is replaced by its \v{C}ech nerve.

\begin{proof}
  As $\mu_T$ is an surjection, using the particular case of 
  Giraud-Rezk-Lurie axiom introduced in Section~\ref{sec:giraud-ax},
  we know that $\separated T$ is the colimit of $C(\mu_T)$. 
%
  Thus the result follows from the fact that $C(\mu_T) = C(\id)$,
  which we now show.

  Let $k:\nat$, we will show that 
  \begin{align*}
    &\sum_{t:T^k} (\mu_T t_1 = \mu_T t_2 \land \cdots
      \land \mu_T t_{k-1} \mu_T t_k)\\
    &= \sum_{t:T^k} \modal_n (t_1 = t_2 \land \cdots
      \land t_{k-1} = t_k)
  \end{align*}
By induction on $k$, and the preservation of products by $\modal_n$, it
suffices to show that for any $a,b:T$, $\modal_n (a=b) = (\mu_T a =
\mu_T b)$. By univalence, we want arrows in both ways, forming an
equivalence.
\begin{itemize}
\item Suppose $p : (\mu_T a = \mu_T b)$. Then projecting $p$ along
  first components yields $q : \prod_{t:T} \modal_n(a=t) = \modal_n (b=t)
  $.
  Taking for example $t=b$, we deduce $\modal_n (a=b) = \modal_n(b=b)$,
  and the latter is inhabited by $\eta_{b=b} 1$.
\item Suppose now $p : \modal_n(a=b)$. Let $\iota$ be the first
  projection from $\separated T \to (T \to \Type_n^\modal)$. $\iota$ is
  an embedding, thus it suffices to prove $\iota (\mu_T a) = \iota
  (\mu_T b)$, \ie $\prod_{t:T}\modal_n (a=t) = \modal_n (b=t)$. The latter
  remains true by univalence.
\end{itemize}
The fact that these two form an equivalence is technical, we refer to
the formalization for an explicit proof.
\end{proof}

Now, let $Q$ be a separated $\Type_{n+1}$, and $f:T \to Q$. Then the
following diagram commutes
$$\xymatrix @C=4em{ 
    \cdots \overline{\Delta_3} \tar[r]{4pt} \ar[rd]_{f\circ \pi_1} & \overline{\Delta_2}
    \dar[r]{2pt} \ar[d]^{f\circ \pi_1} &
    \overline{\Delta_1} = T \ar[ld]^{f\circ \pi_1}\\
    & Q &
  }$$
But we know (lemma~\ref{lem:sepiscolim}) that $\separated T$ is the
colimit of the closed diagonals diagram, thus there is an universal
arrow $\separated T \to Q$.
%
This is enough to state the following proposition.
\begin{prop}\label{prop:sep-subu}
  $(\separated,\mu)$ defines a reflective subuniverse on $\Type_{n+1}$.
\end{prop}

To show that $\separated$ is a modality, it remains to show point {\it (v)}. Let $A:\Type_{n+1}$ be a sheaf and $B:A \to \Type_{n+1}$ be
a sheaf family. We want to show that $\sum_{x:A} (Bx)$ is
separated. Let $E$ be a type, and $\sum_{e:E} (\chi\,e)$ a dense
subobject of E.

Let $f,g$ be two maps from $\sum_{e:E} (\chi\,e)$ to $\sum_{x:A}
(Bx)$, equal when precomposed with $\pi_1$.
$$\xymatrix @R=4em @C=4em{
  \sum_{e:E} (\chi\, e) \ar@<-2pt>[r]_{g\circ\pi_1} \ar@<2pt>[r]^{f\circ \pi_1} \ar[d]_{\mathrm{dense}}& \sum_{x :A} (Bx) \\
  E \ar@<-2pt>[ru]_{g} \ar@<2pt>[ru]^{f}&
}$$
We can restrict the previous diagram to 
$$\xymatrix @R=4em @C=5em{
  \sum_{e:E} (\chi\, e) \ar@<-2pt>[r]_{\pi_1\circ g\circ\pi_1} \ar@<2pt>[r]^{\pi_1\circ f\circ \pi_1} \ar[d]_{\mathrm{dense}}& \sum_{x :A} (Bx) \\
  E \ar@<-2pt>[ru]_{\pi_1\circ g} \ar@<2pt>[ru]^{\pi_1\circ f}&
}$$
and as $A$ is separated, $\pi_1\circ f = \pi_2 \circ g$.
For the second components, let $x:E$. Notice that for any $x:E$,
$\sum_{y:E} x = y$ has a dense subobject, $\sum_{y:\sum_{e:E} (\chi\,
  e)} x=y_1$:

$$\xymatrix@C=8em@R=4em{
  \sum_{y:\sum_{e:E} (\chi\,
  e)} x=y_1 \ar@<2pt>[r]^{\qquad \pi_2\circ f\circ\pi_1\circ \pi_1}
\ar@<-2pt>[r]_{\qquad \pi_2\circ g\circ \pi_1\circ \pi_1}
\ar[d]_{\mathrm{dense}}& B\,x \\
  \sum_{y:E} x = y \ar@<2pt>[ur]^{\pi_2\circ f\circ \pi_1} \ar@<-2pt>[ur]_{\pi_2\circ g\circ \pi_1}&
}$$
Using the sepatation property of $B\,x$, one can show that second
components, transported correctly along the first components equality,
are equal. The complete proof can be found in the formalization.
This proves the following proposition
\begin{prop}\label{prop:sep-mod}
  $(\separated,\mu)$ defines a modality on $\Type_{n+1}$.
\end{prop}

As this modality is just a step in the construction, we do not show
that it is left exact, we will only do it for the sheafification modality.

\subsection{From Separated Type to Sheaf}
\label{ssec:separated-to-sheaf}

%\nt{put the definition of $\modal_{n+1}$ upfront}
If $T:\Type_{n+1}$, let  $\modal_{n+1}T$ be the cloture of $\square T$
seen as a subobject of $T \to \Type_n^\modal$. Explicitly
$$\modal_{n+1} T \defeq \sum_{u:T \to \Type_n^\modal} \modal_{-1}\left\| \sum_{a:T} 
            (\lambda t,~\modal_n (a=t)) = u\right\|$$

We begin by proving that $\modal_{n+1}$ is compatible with $\modal_n$
on lower homotopy types.
\begin{prop}
  If $T:\Type_n$, then $\modal_{n+1}T = \modal_n T$.
\end{prop}
\begin{proof}
  We prove it by induction on $n$~:
  \begin{itemize}
  \item For $n=-1$: Let $T:\HProp$. Then
    \begin{align*}
      \modal_{0} T &= \sum_{u:T \to \Type_n^\modal} \modal_{-1}\left\| \sum_{a:T} 
      (\lambda t,~\modal_{-1} (a=t)) = u\right\| \\
      &= \sum_{u:T \to \Type_n^\modal} \modal_{-1}\left( \sum_{a:T} 
      (\lambda t,~\modal_{-1} (a=t)) = u\right)
    \end{align*}
    because the type inside the truncation is already in $\HProp$.
    Now, let define $\phi : \modal_{-1} T \to \modal_0T$ by
    $$\phi t = (\lambda t',\, \modal_{-1}(t=t') ; \eta
    (t;\mathrm{idpath}))$$
    and $\psi : \modal_0T\to \modal_{-1} T$ by obtaining the
    witness $a:T$ (which is possible because we are trying to inhabit
    a modal proposition), and letting
    $$\psi (u;x) = \eta_T a.$$
    These two maps form an equivalence (the section and retraction are
    trivial because the equivalence is between mere propositions).
  \item Suppose now that $\modal_{n+1}$ is compatible with all $\modal_k$ on
    lower homotopy types. Let $\modal_{n+2}$ be as above, and let
    $T:\Type_{n+1}$. Then
    \begin{align*}
      \modal_{n+2} T &= \hspace{-1em} \sum_{u:T \to \Type_{n+1}^\modal}
                       \hspace{-1em} \modal_{-1}\left\| \sum_{a:T} 
            (\lambda t,~\modal_{n+1} (a=t)) = u\right\| \\
                     &= \hspace{-1em} \sum_{u:T \to
                       \Type_{n+1}^\modal} 
\hspace{-1em} \modal_{-1}\left\| \sum_{a:T} 
            (\lambda t,~\modal_{n} (a=t)) = u\right\|
    \end{align*}
    because $\modal_{n+1}$ is compatible with $\modal_{n}$, and
    $(a=t):\Type_n$.

    It remains to prove that for every $(u,x)$ inhabiting the
    $\Sigma$-type above, $u$ is in $T\to\Type_n^\modal$, \ie that for
    every $t:T$, $\IsType n (u\, t)$.  But for any truncation index $p$,
    the predicate $\IsType p:\HProp$ is a a sheaf, so we can get rid
    of $\modal_{-1}$ and of the truncation, which tells us that for
    every 
    $t:T$, $u\, t = \modal_n(a=t) : \Type_n$.
  \end{itemize}
\end{proof}

This also proves that $\modal_{n+1}$ is compatible with $\modal_{-1}$
in the sense of proposition~\ref{prop:hprop}.

To prove that $\modal_{n+1} T$ is a sheaf for any $T:\Type_{n+1}$, we
use the following:
\begin{lem}
  Let $X:\Type_{n+1}$ be separated, and $U$ be a sheaf. If $X$ embeds
  in $U$, and is closed in $U$, then $X$ is a sheaf.
\end{lem}

As $T\to \Type_n^\modal$ is a sheaf, and any object is closed into its
cloture, $\modal_{n+1}T$ is indeed a sheaf.

\begin{prop}
  $(\modal_{n+1},\nu)$ defines a reflective subuniverse.
\end{prop}
\begin{proof}
  Let $T,Q:\Type_{n+1}$ such that $Q$ is a sheaf. Let $f:T\to Q$.
  Because $Q$ is a sheaf, it is in particular separated ; thus we can
  extend $f$ to $\separated f:\separated T\to Q$.

  But as $\modal_{n+1} T$ is the closure of $\separated T$, $\separated T$ is dense
  into $\modal_{n+1} T$, so the sheaf property of $Q$ allows to extend
  $\separated f$ to $\modal_{n+1} f:\modal_{n+1} T \to Q$.

  As all these steps are universal, the composition is.
\end{proof}

Using the same idea of proof as in proposition~\ref{prop:sep-mod}, we have
\begin{prop}
  $(\modal_{n+1},\nu)$ defines a modality.
\end{prop}

The last step is the left-exactness of $\modal_{n+1}$. Let
$T:\Type_{n+1}$, and $x,y:T$. Suppose that $\Contr(\modal_{n+1} T)$.
Thanks to compatibility between $\modal_{n+1}$ and $\modal_n$ for
$\Type_n$, it suffices to show that $\modal_n(x=y)$ is contractible.

The same proof as in proposition~\ref{prop:sep-subu} leads to
\begin{prop}
  For all $a,b:T$, $\modal_n(a=b) = (\nu_T a = \nu_T b)$.
\end{prop}
As $\modal_{n+1} T$ is contractible, any path space of $\modal T$ is
contractible, in particular $(\nu_T a=\nu_T b)$.

\subsection{Summary}
\label{ssec:summary}

Starting from any left-exact modality $\modal_{-1}$ on $\HProp$, we
defined in this paper a new left-exact modality $\modal$ on
$\sum_{T:\Type} \sum_{n} \IsType n T$, which is exactly $\modal_{-1}$
when restricted to $\HProp$.

If $\modal_{-1}$ is the double negation modality on $\HProp$, it is obvious
that $\modal_{-1}\zero=\zero$, hence the homotopy type theory induced by
$\modal$ is consistent by proposition~\ref{prop:consistent}.

In topos theory, the topos of Lawvere-Tierney sheaves for the double
negation topology is a boolean topos. In homotopy type theory, this
result can be expressed as:

\begin{prop}
  If $\modal_{-1}=\modal_{\lnot\lnot}$, and $\modal$ is the modality
  as defined above, then the propositional excluded middle is true in
  the induced type theory.
\end{prop}


\nt{Recap what has been done, and give the final result about EM with
  the dense topology as a corollary.}

\section{Formalization} 
\label{sec:formalization}

A Coq formalization is available at
\url{https://github.com/KevinQuirin/sheafification}.
%
It is based on the homotopy type theory library available at
\url{https://github.com/HoTT/HoTT}.

We provide a more detailed insight of where properties have been
formalized, and what is the size of the formalisation for each part:
\begin{itemize} 
\item  Homotopy fibers and subobject classifiers are formalized in
\texttt{sub\_object\_classifier.v} (284 lines).
%
\item Colimits, $p$-pullbacks and \v{C}ech nerves are formalized in
\texttt{colimits.v, cech\_nerve.v} (552 lines).
\item
Reflective subuniverses and modalities are formalized in
\texttt{reflective\_subuniverse.v, modalities.v} (1053 lines).
\item 
%
  The definition of the dense topology as a left exact modality on
  $\HProp$ is given in \texttt{sheaf\_base\_case.v} (186 lines).
\item
Section~\ref{sec:sheaves} is formalized in
\texttt{sheaf\_def\_and\_thm.v} (1029 lines).
\item
Section~\ref{sec:sheafification} is formalized in
\texttt{sheaf\_induction.v} (2340 lines).
\end{itemize}

Overall, with other files containing technical lemmas, the project
contains 6322 lines, and it could be reduced a bit by improving the
way Coq tries to rewrite and apply lemmas automatically. 
%
This constitute a significant amount of work but the part dedicated to
sheaves and sheafification is only 4000, which seems quite reasonable
and is encouraging, because it suggests that homotopy type theory
provides a convenient tool to formalize some part of the theory of
higher topoi. As a matter of comparison, this \TeX\xspace file contains
approximatively 1800 lines.

% In our formalization, some things are admitted, either because they
% are just an adaptation of a proposition already formalized
% in~\cite{hottbook}, either because they are true, but very technical:
% \begin{itemize}
% \item in \texttt{modalities.v}, an equality is admitted in the proof
%   of proposition~\ref{sec:defin-basic-prop}.
% \item in \texttt{nat\_lemmas.v}, the proof that $\IsHProp (n\leqslant
%   m)$ is admitted.
% \item in \texttt{sheaf\_induction.v}, in the proof that
%   $C(\mu_T)=(C\id)$ (see lemma~\ref{lem:sepiscolim}), we admit the proof
%   of equality of projections.
% \item in \texttt{sheaf\_induction.v}, we admit some very technical
%   proofs in proofs that $\square$ and $\star$ are modalities.
% \item in \texttt{sheaf\_induction.v}, cumulativity is an axiom,
%   because of universes issues.
% \end{itemize}

In our formalization of sheafification defined
Section~\ref{sec:sheafification} (done in 
\texttt{sheaf\_induction.v}), two very technical facts required to
show that $\square$ is a modality have been
admitted. 
\nt{say that it comes from a lack of lemmas on paths between paths in
  the HoTT library}
%
Nevertheless, we are confident that they can be proven and
have been admitted only by lack of time.
In the proof that diagrams are equal in lemma~\ref{lem:sepiscolim},
the equality of projections is admitted, because if this proof is
obvious on paper, it becomes really technical when formalized.
As a consequence, the fact that $P$ is a colimit of the diagonal
closed diagram is admitted too, but again, this proof should be really
short as it is on paper.

More importantly, there are few axioms in the formalization that are
due to an unsatisfactory management of polymorphic universe level in
Coq~\cite{sozeau2014universe}.
%
\nt{Say a word about polymorphic universe level, consistency check,
  and the fact that polymorphic universe level are nevertheless
  mandatory for our formalization}


%
If Coq handles cumulativity on all $\Type$ natively, it is not
the case for the $\Sigma$-type $\Type_n$, which require propositional
resizing. 
%
This issue could be solved by adding an axiom of cumulativity
for $\Type_n$ with an explicit management of universes. 
%
But as it would not have any computational content, it
would really complicates the proofs as the axiom would appear
everywhere cumulativity is needed and it would need explicitly
annotation for universe levels everywhere in the formalization.

We have chosen a more simple but less satisfactory solution. 
%
When the absence of cumulativity rises a universe issue for a lemma,
we have proven the lemma and then admit the exact same lemma, just to
let Coq infer less constrained universe levels.

An other issue with universe polymorphism lies in their management for
recursive definitions. Indeed, the definition of successive sheafification types is
not allowed:
%
\[ \left\{
    \begin{array}{l}
      \modal_{-1} = \lambda T:\HProp,~ \lnot\lnot T \\
      \displaystyle{\modal_{n+1} = \lambda T:\Type_{n+1}},\\
      \quad \displaystyle{\sum_{u:T \to \Type_n^\modal} \modal_{-1} 
      \left\|
      \sum_{a:T} u = (\lambda t,~\modal_n (a=t))
      \right\|}
    \end{array}
  \right.\]
%
because Coq asks for every $\modal_n$ to have the same universes
levels in the recursive definition. 
%
\nt{explain why it is an issue.}
%
Thus, the induction step presented in this paper has been formalized,
but the complete induction can not be formalized at the moment. 
%
This restriction in our formalization can not be solved without
generalizing universe polymorphism for recursive definition.
%
% In particular, compoatcumulativity is an axiom, because of
% universes issues.


\section{Conclusion and Future Works}
\label{sec:future-works}

In this paper, we defined a way to extend type theory with new
principles, using the already known method in topos theory,
sheafification. Using this method, one an add some principles, like
excluded middle, to type theory, but with computational content, while
doing it with axiom break the extraction of proofs.



Beyond the result, this work allows to illustrate some homotopy type theoritical
techniques, as well as use of proof assistants.

\kq{J'ai un peu copié sur la conclusion de Licata ``Eilenberg MacLane
  spaces''. Si ça pose problème, je changerai.}

In future works, we would like to improve this construction in two
ways:
\begin{itemize}
\item At the moment, the sheafification process only works with
  truncated types. But some classical types in homotopy type theory
  are not truncated, like the circle $\mathbb S^1$. 
  Thus, we plan to extend the sheafification to all types, even if non
  truncated
\item In this work, the Giraud-Rezk-Lurie axiom is admitted. The work
  done in~\cite{lurie} suggests, if we see homotopy type theory as
  higher topos theory, that this axiom could be provable. A
  computer-checked proof of this fact would improve our developpement.
\end{itemize}
Moreover, in topos theory, we know that Lawvere-Tierney subsumes
Grothendieck (\cite{maclanemoerdijk}, section~V.4). Higher Lawvere-Tierney sheaves are
presented here, and higher Grothendieck sheaves in~\cite{lurie} ; we want to
check if this remains true in higher topos theory.





% conference papers do not normally have an appendix


% use section* for acknowledgment
\section*{Acknowledgment}

We would like to thank all maintainers of the Coq/HoTT library, who
allowed us to base our formalization on something. We would also like
to thank Bas Spitters for the helpful discussions on the subject.

% trigger a \newpage just before the given reference
% number - used to balance the columns on the last page
% adjust value as needed - may need to be readjusted if
% the document is modified later
%\IEEEtriggeratref{8}
% The "triggered" command can be changed if desired:
%\IEEEtriggercmd{\enlargethispage{-5in}}

% references section

% can use a bibliography generated by BibTeX as a .bbl file
% BibTeX documentation can be easily obtained at:
% http://www.ctan.org/tex-archive/biblio/bibtex/contrib/doc/
% The IEEEtran BibTeX style support page is at:
% http://www.michaelshell.org/tex/ieeetran/bibtex/
\bibliographystyle{IEEEtran}
\bibliography{sheaf_lics}
% argument is your BibTeX string definitions and bibliography database(s)
%\bibliography{IEEEabrv,../bib/paper}
%
% <OR> manually copy in the resultant .bbl file
% set second argument of \begin to the number of references
% (used to reserve space for the reference number labels box)
% \begin{thebibliography}{5}


% that's all folks

\end{document}
